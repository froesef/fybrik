# Copyright 2020 IBM Corp.
# SPDX-License-Identifier: Apache-2.0

apiVersion: app.fybrik.io/v1alpha1
kind: Plotter
metadata:
  name: plotter
  namespace: fybrik-system
  labels:
    app.fybrik.io/appNamespace: default
    app.fybrik.io/appName: notebook
spec:
  assets:
    S3:
      assetId: "S3"  # dataset requested by user
      credentials:
        read:
          vault:
            address: http://vault.fybrik-system:8200
            authPath: /v1/auth/kubernetes/login
            role: module
            secretPath: "/v1/kubernetes-secrets/secret-name?namespace=default"
      connection:
        s3:
          bucket: my-bucket
          endpoint: s3.eu-gb.cloud-object-storage.appdomain.cloud
          object_key: my-object
        type: 2
      dataformat: parquet
    DB2:
      assetId: "DB2"  # dataset requested by user
      credentials:
        read:
          vault:
            address: http://vault.fybrik-system:8200
            authPath: /v1/auth/kubernetes/login
            role: module
            secretPath: "/v1/kubernetes-secrets/secret-name?namespace=default"
      connection:
        db2:
          port: "5000"
          table: SMALL
          database: MYDB
          url: mydb
          ssl: "true"
      dataformat: table
  flows:
  - name: notebook
    flowType: copy
    assetId: "DB2"
    subflows:
    - name: subflow-copy
      flowType: copy
      triggers:
      - workload
      steps:
      - - name: step1
          cluster: thegreendragon
          template: copyTemplate
          parameters:
            source:
              assetId: "DB2"
            sink:
              assetId: "S3"
  templates:
    copyTemplate:
      name: copyTemplate
      modules:
      - name: implicit-copy-batch-latest
        kind: FybrikModule
        type: service
        chart:
          name: ghcr.io/mesh-for-data/m4d-implicit-copy-batch:0.1.0
        capabilities:
        - capability: copy
          scope: workload
          actions:   # Not being used in current scenario
            - id: redact-ID
              level: 2  # column
            - id: removed-ID
              level: 2  # column

  selector: {}

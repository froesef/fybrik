apiVersion: app.m4d.ibm.com/v1alpha2
kind: Blueprint
metadata:
  name: app1-ns1
  labels:
spec:
  cluster: thegreendragon
  appSelector: # Selector of the application that uses this workload
    clusterName: thegreendragon
    workloadSelector:
      matchLabels:
        app: demoapp
  modules:
  - name: app1-ns1-read
    serviceModule: arrow-flight-server1
    chart:
      name: ghcr.io/mesh-for-data/arrow-flight-config-module:0.1.0
    arguments:
      read:
        - assetId: "m4d-notebook-sample/paysim"
          vault:
            address: http://vault.m4d-system:8200
            authPath: /v1/auth/kubernetes/login
            role: module
            secretPath: /v1/kubernetes-secrets/paysim?namespace=m4d-notebook-sample
          connection:
            s3:
              endpoint: localhost:8001
              bucket: srcbucket
              object: paysim.parq
          dataformat: parquet
        - assetId: "m4d-notebook-sample/users"
          vault:
            address: http://vault.m4d-system:8200
            authPath: /v1/auth/kubernetes/login
            role: module
            secretPath: /v1/kubernetes-secrets/users?namespace=m4d-notebook-sample
          connection:
            s3:
              endpoint: localhost:8001
              bucket: srcbucket
              object: users.parq
          dataformat: parquet
        - assetId: "m4d-notebook-sample/inventory"
          vault:
            address: http://vault.m4d-system:8200
            authPath: /v1/auth/kubernetes/login
            role: module
            secretPath: /v1/kubernetes-secrets/inventory?namespace=m4d-notebook-sample
          connection:
            s3:
              endpoint: localhost:8001
              bucket: srcbucket
              object: inventory.parq
          dataformat: parquet
  - name: app1-ns1-transform-read
    serviceModule: arrow-flight-server2 # external-where is name from?
    chart:
      name: ghcr.io/mesh-for-data/arrow-flight-config-module:0.1.0
    arguments: 
      read:
        - assetID: m4d-notebook-sample/paysim-step2  
          connection:
            arrow-flight:
              assetId: paysim-step2
              endpoint: "app1-ns1-transform-read"
          actions:
          - action: redact
            column: field1
        - assetID: m4d-notebook-sample/users-step2
          connection:
            arrow-flight:
              assetId: users-step2
              endpoint: "app1-ns1-transform-read"
          actions:
          - action: redact
            column: blood_group
        - assetID: m4d-notebook-sample/inventory-step2
          connection:
            arrow-flight:
              assetId: inventory-step2
              endpoint: "app1-ns1-transform-read"
          actions:
          - action: redact
            column: field2
  - name: transform-step
    chart:
      name: ghcr.io/mesh-for-data/m4d-arrow-flight-transform-conf:0.1.0
    serviceModule: app1-ns1-transform # name of service to be configured
status:
  observedState: Not Ready
  observedGeneration: 1
  releases:
  assets:
  - assetId: "m4d-notebook-sample/paysim"
    state: Ready
  - assetId: "m4d-notebook-sample/users"
    state: Ready
  - assetId: "m4d-notebook-sample/inventory"
    state: Ready
